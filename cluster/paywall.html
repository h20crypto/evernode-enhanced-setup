<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Cluster Manager License | Enhanced Evernode</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .paywall-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .license-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .license-header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .price {
            font-size: 3rem;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
        }
        
        .price-subtitle {
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        .benefits {
            margin: 30px 0;
            list-style: none;
        }
        
        .benefits li {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .benefits li::before {
            content: "‚úÖ";
            font-size: 1.2rem;
        }
        
        .payment-options {
            margin: 30px 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .payment-method {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .payment-method:hover {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.1);
        }
        
        .payment-method.selected {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.2);
        }
        
        .method-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .rate-info {
            font-size: 0.8rem;
            opacity: 0.7;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 215, 0, 0.3);
        }
        
        .btn-secondary {
            background: transparent;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn-secondary:hover {
            border-color: #FFD700;
            color: #FFD700;
        }
        
        .crypto-details {
            display: none;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .crypto-details.active {
            display: block;
        }
        
        .qr-code {
            text-align: center;
            margin: 20px 0;
        }
        
        .payment-address {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #FFD700;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success-message {
            background: rgba(0, 255, 0, 0.2);
            border: 2px solid #00ff00;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
        }
        
        .license-verification {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .license-input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 1rem;
            margin: 10px 0;
        }
        
        .license-input:focus {
            outline: none;
            border-color: #FFD700;
        }
        
        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            text-decoration: none;
            opacity: 0.7;
        }
        
        .back-link:hover {
            opacity: 1;
            color: #FFD700;
        }
        
        .pricing-mode {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        .pricing-mode select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 5px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .api-cost-info {
            font-size: 0.7rem;
            opacity: 0.6;
            text-align: center;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-link">‚Üê Back to Enhanced Evernode</a>
    
    <div class="paywall-container">
        <div class="license-header">
            <h1>üéØ Cluster Manager License</h1>
            <div class="price">$49.99</div>
            <div class="price-subtitle">One-time purchase ‚Ä¢ Lifetime access</div>
        </div>
        
        <ul class="benefits">
            <li>Unlimited cluster creation</li>
            <li>One-click instance extensions</li>
            <li>Real-time monitoring dashboard</li>
            <li>Global host discovery</li>
            <li>Priority support</li>
            <li>Future updates included</li>
        </ul>
        
        <div class="pricing-mode">
            <label for="pricing-accuracy">Pricing Accuracy:</label>
            <select id="pricing-accuracy" onchange="updatePricingMode()">
                <option value="balanced">Balanced (Recommended)</option>
                <option value="cheap">Economy Mode</option>
                <option value="accurate">High Precision</option>
                <option value="realtime">Real-time</option>
            </select>
            <div class="api-cost-info" id="api-cost-info">Updates every 2 minutes ‚Ä¢ ~$1.20/month API cost</div>
        </div>
        
        <div class="payment-options">
            <div class="payment-method" onclick="selectPayment('xrp')" id="xrp-option">
                <div class="method-header">
                    <span>ü™ô Pay with XRP</span>
                    <span id="xrpAmount">~119 XRP</span>
                </div>
                <div class="rate-info">
                    Rate: $<span id="xrpRate">0.420</span> per XRP
                    <small id="xrpUpdate">(loading...)</small>
                </div>
            </div>
            
            <div class="payment-method" onclick="selectPayment('evr')" id="evr-option">
                <div class="method-header">
                    <span>‚ö° Pay with EVR</span>
                    <span id="evrAmount">~227 EVR</span>
                </div>
                <div class="rate-info">
                    Rate: $<span id="evrRate">0.220</span> per EVR
                    <small id="evrUpdate">(loading...)</small>
                </div>
            </div>
            
            <div class="payment-method" onclick="selectPayment('usd')" id="usd-option">
                <div class="method-header">
                    <span>üíµ Pay with USD Stablecoin</span>
                    <span>$49.99 USDC</span>
                </div>
                <div class="rate-info">
                    Exact USD amount ‚Ä¢ No volatility risk
                </div>
            </div>
            
            <div class="payment-method" onclick="selectPayment('traditional')" id="traditional-option">
                <div class="method-header">
                    <span>üí≥ Credit Card / PayPal</span>
                    <span>$49.99 USD</span>
                </div>
                <div class="rate-info">
                    Visa, Mastercard, PayPal accepted
                </div>
            </div>
        </div>
        
        <div class="crypto-details" id="crypto-details">
            <h3>Send Payment</h3>
            <div class="payment-address" id="payment-address"></div>
            <div class="qr-code" id="qr-code"></div>
            <p><strong>Destination Tag:</strong> <span id="dest-tag"></span></p>
            <p><strong>Amount:</strong> <span id="exact-amount"></span></p>
            <p><small>Rate locked for 1 hour ‚Ä¢ <span id="rate-source"></span></small></p>
            
            <div class="loading" id="payment-loading" style="display: none;">
                <div class="spinner"></div>
                <p>Waiting for payment confirmation...</p>
                <small>Usually takes 3-5 seconds</small>
            </div>
        </div>
        
        <button class="btn btn-primary" id="main-action" onclick="proceedWithPayment()">
            Choose Payment Method
        </button>
        
        <button class="btn btn-secondary" onclick="showLicenseVerification()">
            üîì I Already Have a License
        </button>
        
        <div class="license-verification" id="license-verification" style="display: none;">
            <h3>Verify Existing License</h3>
            <p>Enter your Xahau wallet address or license code:</p>
            <input type="text" class="license-input" id="license-input" 
                   placeholder="rYourXahauAddress... or EVER-XXXX-XXXX-XXXX">
            <button class="btn btn-primary" onclick="verifyLicense()">
                Verify License
            </button>
        </div>
        
        <div class="success-message" id="success-message" style="display: none;">
            <h3>üéâ License Activated!</h3>
            <p>Your Cluster Manager license is now active.</p>
            <p><small>License: <span id="license-code"></span></small></p>
            <button class="btn btn-primary" onclick="redirectToClusterWizard()">
                Start Creating Clusters
            </button>
        </div>
    </div>
    
    <script>
        let selectedPayment = null;
        let cryptoRates = {};
        let paymentMonitor = null;
        let currentMode = 'balanced';
        let updateInterval = null;
        
        const modeDescriptions = {
            cheap: 'Updates every 2 minutes ‚Ä¢ ~$0.50/month API cost',
            balanced: 'Updates every 90 seconds ‚Ä¢ ~$1.20/month API cost',
            accurate: 'Updates every minute ‚Ä¢ ~$2.00/month API cost',
            realtime: 'Updates every 30 seconds ‚Ä¢ ~$4.00/month API cost'
        };
        
        const updateIntervals = {
            cheap: 120000,    // 2 minutes
            balanced: 90000,  // 90 seconds
            accurate: 60000,  // 1 minute
            realtime: 30000   // 30 seconds
        };
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            updateCryptoRates();
            startPeriodicUpdates();
            
            // Check if user already has license
            checkExistingLicense();
        });
        
        function updatePricingMode() {
            currentMode = document.getElementById('pricing-accuracy').value;
            document.getElementById('api-cost-info').textContent = modeDescriptions[currentMode];
            
            // Update rates immediately with new mode
            updateCryptoRates();
            
            // Restart periodic updates with new interval
            startPeriodicUpdates();
        }
        
        function startPeriodicUpdates() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            updateInterval = setInterval(() => {
                updateCryptoRates();
            }, updateIntervals[currentMode]);
        }
        
        async function updateCryptoRates() {
            try {
                const response = await fetch('../api/crypto-rates-optimized.php?mode=balanced');
                cryptoRates = await response.json();
                
                // Update XRP pricing
                document.getElementById('xrpAmount').textContent = cryptoRates.xrp.display;
                document.getElementById('xrpRate').textContent = cryptoRates.xrp.rate.toFixed(3);
                
                // Update EVR pricing
                document.getElementById('evrAmount').textContent = cryptoRates.evr.display;
                document.getElementById('evrRate').textContent = cryptoRates.evr.rate.toFixed(3);
                
                // Update timestamps and sources
                const updateTime = new Date(cryptoRates.timestamp * 1000).toLocaleTimeString();
                document.getElementById('xrpUpdate').textContent = 
                    `(${cryptoRates.xrp.source}, ${updateTime})`;
                document.getElementById('evrUpdate').textContent = 
                    `(${cryptoRates.evr.source}, ${updateTime})`;
                
                // Show API costs if incurred
                if (cryptoRates.costs_incurred && cryptoRates.costs_incurred > 0) {
                    const costInfo = document.getElementById('api-cost-info');
                    costInfo.innerHTML += ` ‚Ä¢ Last call: ${cryptoRates.costs_incurred.toFixed(6)}`;
                }
                
            } catch (error) {
                console.error('Failed to update crypto rates:', error);
                // Show error in update info
                document.getElementById('xrpUpdate').textContent = '(network error)';
                document.getElementById('evrUpdate').textContent = '(network error)';
            }
        }
        
        function selectPayment(method) {
            selectedPayment = method;
            
            // Remove selected class from all options
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Add selected class to chosen option
            document.getElementById(method + '-option').classList.add('selected');
            
            // Update main action button
            const actionBtn = document.getElementById('main-action');
            
            switch(method) {
                case 'xrp':
                    actionBtn.textContent = `Pay ${cryptoRates.xrp?.display || '~119 XRP'}`;
                    break;
                case 'evr':
                    actionBtn.textContent = `Pay ${cryptoRates.evr?.display || '~227 EVR'}`;
                    break;
                case 'usd':
                    actionBtn.textContent = 'Pay $49.99 USDC';
                    break;
                case 'traditional':
                    actionBtn.textContent = 'Pay with Credit Card';
                    break;
            }
        }
        
        async function proceedWithPayment() {
            if (!selectedPayment) {
                alert('Please select a payment method first');
                return;
            }
            
            switch(selectedPayment) {
                case 'xrp':
                case 'evr':
                case 'usd':
                    await showCryptoPayment();
                    break;
                case 'traditional':
                    window.open('https://buy.stripe.com/your-stripe-link', '_blank');
                    break;
            }
        }
        
        async function showCryptoPayment() {
            const details = document.getElementById('crypto-details');
            const loading = document.getElementById('payment-loading');
            
            details.classList.add('active');
            loading.style.display = 'block';
            
            try {
                // Generate payment details using current rates
                const response = await fetch('../api/xahau-nft-licenses.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generate_payment',
                        currency: selectedPayment,
                        rate_mode: currentMode
                    })
                });
                
                const paymentData = await response.json();
                
                // Update payment details
                document.getElementById('payment-address').textContent = paymentData.address;
                document.getElementById('dest-tag').textContent = paymentData.dest_tag;
                document.getElementById('exact-amount').textContent = paymentData.exact_amount;
                document.getElementById('rate-source').textContent = 
                    `${paymentData.rate_source || 'Dhali Oracle'} at ${paymentData.rate_used}`;
                
                // Start monitoring for payment
                startPaymentMonitoring(paymentData.dest_tag);
                
            } catch (error) {
                console.error('Failed to generate payment:', error);
                alert('Failed to generate payment details. Please try again.');
            } finally {
                loading.style.display = 'none';
            }
        }
        
        function startPaymentMonitoring(destTag) {
            paymentMonitor = setInterval(async () => {
                try {
                    const response = await fetch('../api/crypto-rates-optimized.php?mode=balanced');
                    const result = await response.json();
                    
                    if (result.payment_confirmed) {
                        clearInterval(paymentMonitor);
                        showSuccess(result.license);
                    } else if (result.expired) {
                        clearInterval(paymentMonitor);
                        alert('Payment window expired. Please try again.');
                        document.getElementById('crypto-details').classList.remove('active');
                    }
                } catch (error) {
                    console.error('Payment monitoring error:', error);
                }
            }, 5000); // Check every 5 seconds
        }
        
        function showSuccess(license) {
            document.getElementById('crypto-details').style.display = 'none';
            document.getElementById('success-message').style.display = 'block';
            document.getElementById('license-code').textContent = license;
            
            // Store license locally
            localStorage.setItem('cluster_manager_license', license);
            
            // Stop all price updates since we're done
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        }
        
        function showLicenseVerification() {
            const verification = document.getElementById('license-verification');
            verification.style.display = verification.style.display === 'none' ? 'block' : 'none';
        }
        
        async function verifyLicense() {
            const input = document.getElementById('license-input').value.trim();
            
            if (!input) {
                alert('Please enter your wallet address or license code');
                return;
            }
            
            try {
                const response = await fetch('../api/xahau-nft-licenses.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'verify_license',
                        identifier: input
                    })
                });
                
                const result = await response.json();
                
                if (result.valid) {
                    localStorage.setItem('cluster_manager_license', result.license);
                    showSuccess(result.license);
                } else {
                    alert('License not found. Please check your input or purchase a new license.');
                }
            } catch (error) {
                console.error('License verification failed:', error);
                alert('Verification failed. Please try again.');
            }
        }
        
        function checkExistingLicense() {
            const stored = localStorage.getItem('cluster_manager_license');
            if (stored) {
                showSuccess(stored);
            }
        }
        
        function redirectToClusterWizard() {
            window.location.href = 'wizard.html';
        }
    </script>
</body>
</html>
