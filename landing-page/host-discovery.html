<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Enhanced Evernode Host Discovery</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #fff;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            border-radius: 15px;
            border: 1px solid #333;
        }
        
        .title {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00ff88, #00cc99);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #aaa;
            font-size: 1.1em;
            margin-bottom: 20px;
        }
        
        .controls-section {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
            align-items: center;
        }
        
        .search-input {
            width: 100%;
            padding: 15px 20px;
            background: #2a2a2a;
            border: 2px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }
        
        .sort-select {
            padding: 15px 20px;
            background: #2a2a2a;
            border: 2px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
        }
        
        .sort-select:focus {
            outline: none;
            border-color: #00ff88;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #ccc;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #333;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #aaa;
            font-size: 0.9em;
        }
        
        .results-container {
            background: #1a1a1a;
            border-radius: 12px;
            border: 1px solid #333;
            overflow: hidden;
        }
        
        .results-header {
            background: #2a2a2a;
            padding: 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .refresh-btn {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .refresh-btn:hover {
            background: #00cc99;
        }
        
        .hosts-grid {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .host-card {
            background: #1a1a1a;
            padding: 20px;
            border-bottom: 1px solid #333;
            transition: all 0.3s ease;
        }
        
        .host-card:hover {
            background: #252525;
        }
        
        .host-card.your-host {
            background: linear-gradient(90deg, rgba(255, 107, 107, 0.1), #1a1a1a);
            border-left: 4px solid #ff6b6b;
        }
        
        .host-domain {
            font-size: 1.2em;
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 5px;
        }
        
        .host-address {
            font-family: monospace;
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 10px;
        }
        
        .host-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .info-label {
            font-size: 0.8em;
            color: #888;
            text-transform: uppercase;
        }
        
        .info-value {
            color: #ccc;
            font-weight: 500;
        }
        
        .quality-score {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .score-bar {
            flex: 1;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ffd700, #00ff88);
            transition: width 0.5s ease;
        }
        
        .host-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 16px;
            border: 1px solid #444;
            background: #2a2a2a;
            color: #ccc;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .action-btn:hover {
            border-color: #00ff88;
            color: #00ff88;
        }
        
        .action-btn.primary {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
        }
        
        .action-btn.primary:hover {
            background: #00cc99;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #aaa;
        }
        
        .cache-status {
            font-size: 0.8em;
            color: #888;
        }
        
        .your-host-badge {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: #fff;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 10px;
        }
        
        .reward-badge {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            border: 1px solid #333;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #fff;
        }
        
        .deploy-code {
            background: #000;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 0.9em;
            overflow-x: auto;
        }
        
        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .filter-buttons {
                justify-content: center;
            }
            
            .host-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üîç Enhanced Host Discovery</h1>
            <p class="subtitle">Real-time Evernode network exploration with advanced search & sorting</p>
            <div id="lastUpdate" class="cache-status">Initializing...</div>
        </div>

        <div class="controls-section">
            <div class="controls-grid">
                <input type="text" id="searchInput" class="search-input" placeholder="Search by r-address, domain, email, or country...">
                
                <select id="sortSelect" class="sort-select">
                    <option value="quality">üèÜ Quality Score</option>
                    <option value="reputation">‚≠ê Reputation</option>
                    <option value="cost">üí∞ Cost (Low to High)</option>
                    <option value="cost_desc">üí∞ Cost (High to Low)</option>
                    <option value="cpu">üíª CPU Cores</option>
                    <option value="memory">üß† Memory</option>
                    <option value="disk">üíæ Disk Space</option>
                    <option value="country">üåç Country</option>
                    <option value="availability">üìä Availability</option>
                </select>
                
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="enhanced">Enhanced</button>
                    <button class="filter-btn" data-filter="rewards">Rewards</button>
                    <button class="filter-btn" data-filter="available">Available</button>
                </div>
            </div>
        </div>

        <div class="stats-grid" id="networkStats">
            <div class="stat-card">
                <div class="stat-value" id="totalHosts">-</div>
                <div class="stat-label">Total Hosts</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeHosts">-</div>
                <div class="stat-label">Online Hosts</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="enhancedHosts">-</div>
                <div class="stat-label">Enhanced Hosts</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="rewardHosts">-</div>
                <div class="stat-label">Reward Eligible</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgCost">$-</div>
                <div class="stat-label">Avg Cost/Hour</div>
            </div>
        </div>

        <div class="results-container">
            <div class="results-header">
                <div>
                    <span id="resultsCount">0</span> hosts found
                    <span id="searchQuery"></span>
                </div>
                <button id="refreshBtn" class="refresh-btn">üîÑ Refresh</button>
            </div>
            <div id="hostResults" class="hosts-grid">
                <div class="loading">Loading Evernode hosts...</div>
            </div>
        </div>
    </div>

    <!-- Deploy Command Modal -->
    <div id="deployModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 style="color: #00ff88; margin-bottom: 20px;">üöÄ Deploy to Host</h2>
            <div id="deployContent"></div>
        </div>
    </div>

    <!-- Host Details Modal -->
    <div id="hostModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 style="color: #00ff88; margin-bottom: 20px;">üìä Host Details</h2>
            <div id="hostContent"></div>
        </div>
    </div>

    <script>
        class HostDiscovery {
            constructor() {
                this.hosts = [];
                this.filteredHosts = [];
                this.currentQuery = '';
                this.currentSort = 'quality';
                this.currentFilter = 'all';
                
                this.initializeElements();
                this.bindEvents();
                this.loadData();
                
                setInterval(() => this.loadNetworkData(), 600000);
            }

            initializeElements() {
                this.elements = {
                    searchInput: document.getElementById('searchInput'),
                    sortSelect: document.getElementById('sortSelect'),
                    hostResults: document.getElementById('hostResults'),
                    resultsCount: document.getElementById('resultsCount'),
                    searchQuery: document.getElementById('searchQuery'),
                    refreshBtn: document.getElementById('refreshBtn'),
                    lastUpdate: document.getElementById('lastUpdate'),
                    stats: {
                        totalHosts: document.getElementById('totalHosts'),
                        activeHosts: document.getElementById('activeHosts'),
                        enhancedHosts: document.getElementById('enhancedHosts'),
                        rewardHosts: document.getElementById('rewardHosts'),
                        avgCost: document.getElementById('avgCost')
                    }
                };
            }

            bindEvents() {
                // Search input
                this.elements.searchInput.addEventListener('input', (e) => {
                    this.handleSearch(e.target.value);
                });

                // Sort select
                this.elements.sortSelect.addEventListener('change', (e) => {
                    this.currentSort = e.target.value;
                    this.applyFilters();
                });

                // Filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentFilter = e.target.dataset.filter;
                        this.applyFilters();
                    });
                });

                // Refresh button
                this.elements.refreshBtn.addEventListener('click', () => {
                    this.refreshData();
                });

                // Modal events
                this.bindModalEvents();
            }

            bindModalEvents() {
                // Close modals when clicking X or outside
                document.querySelectorAll('.close').forEach(close => {
                    close.addEventListener('click', (e) => {
                        e.target.closest('.modal').style.display = 'none';
                    });
                });

                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        e.target.style.display = 'none';
                    }
                });
            }

            async loadData() {
                await Promise.all([
                    this.loadNetworkData(),
                    this.loadHosts()
                ]);
            }

            async loadNetworkData() {
                try {
                    const response = await fetch('/api/evernode-stats-cached.php');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.updateNetworkStats(data.stats);
                        this.updateCacheStatus(data.cache_status, data.cache_age);
                    } else {
                        this.showFallbackStats();
                    }
                } catch (error) {
                    console.warn('Failed to load network stats:', error);
                    this.showFallbackStats();
                }
            }

            async loadHosts() {
                try {
                    const response = await fetch('/api/enhanced-search.php?action=search&limit=1000');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.hosts = data.hosts;
                        this.applyFilters();
                    } else {
                        throw new Error('Failed to load hosts');
                    }
                } catch (error) {
                    console.error('Failed to load hosts:', error);
                    this.elements.hostResults.innerHTML = '<div class="loading">Unable to load hosts</div>';
                }
            }

            updateNetworkStats(stats) {
                this.elements.stats.totalHosts.textContent = this.formatNumber(stats.total_hosts);
                this.elements.stats.activeHosts.textContent = this.formatNumber(stats.active_hosts);
                this.elements.stats.enhancedHosts.textContent = this.formatNumber(stats.estimated_enhanced);
                this.elements.stats.rewardHosts.textContent = this.formatNumber(stats.reward_eligible_hosts || stats.high_reputation_hosts);
                this.elements.stats.avgCost.textContent = `${(stats.average_cost_usd || 0).toFixed(8)}`;
            }

            showFallbackStats() {
                this.elements.stats.totalHosts.textContent = '11,859';
                this.elements.stats.activeHosts.textContent = '7,006';
                this.elements.stats.enhancedHosts.textContent = '247';
                this.elements.stats.rewardHosts.textContent = '6,637';
                this.elements.stats.avgCost.textContent = '$0.000180';
                this.updateCacheStatus('fallback');
            }

            updateCacheStatus(status, age = 0) {
                const statusEl = this.elements.lastUpdate;
                const now = new Date().toLocaleTimeString();
                
                switch (status) {
                    case 'hit':
                        statusEl.textContent = `Cached ${Math.round(age / 60)}m ago - ${now}`;
                        break;
                    case 'miss':
                    case 'busted':
                        statusEl.textContent = `Fresh data - ${now}`;
                        break;
                    default:
                        statusEl.textContent = `Last updated: ${now}`;
                }
            }

            handleSearch(query) {
                this.currentQuery = query.toLowerCase().trim();
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    this.applyFilters();
                }, 300);
            }

            applyFilters() {
                let filtered = [...this.hosts];
                
                // Apply search filter
                if (this.currentQuery) {
                    filtered = filtered.filter(host => {
                        return (
                            (host.address || '').toLowerCase().includes(this.currentQuery) ||
                            (host.domain || '').toLowerCase().includes(this.currentQuery) ||
                            (host.email || '').toLowerCase().includes(this.currentQuery) ||
                            (host.countryCode || '').toLowerCase().includes(this.currentQuery)
                        );
                    });
                }
                
                // Apply category filter
                if (this.currentFilter !== 'all') {
                    filtered = filtered.filter(host => {
                        switch (this.currentFilter) {
                            case 'enhanced':
                                return host.is_enhanced || host.quality_score >= 70;
                            case 'rewards':
                                return host.receives_evr_rewards || (host.hostReputation || 0) >= 200;
                            case 'available':
                                return (host.hardware_summary?.available_instances || 0) > 0;
                            default:
                                return true;
                        }
                    });
                }
                
                // Apply sort
                this.sortHosts(filtered);
                
                this.filteredHosts = filtered;
                this.renderHosts();
                this.updateResultsInfo();
            }

            sortHosts(hosts) {
                hosts.sort((a, b) => {
                    switch (this.currentSort) {
                        case 'quality':
                            return (b.quality_score || 0) - (a.quality_score || 0);
                        case 'reputation':
                            return (b.hostReputation || 0) - (a.hostReputation || 0);
                        case 'cost':
                            return (a.pricing?.usd_per_hour || 0) - (b.pricing?.usd_per_hour || 0);
                        case 'cost_desc':
                            return (b.pricing?.usd_per_hour || 0) - (a.pricing?.usd_per_hour || 0);
                        case 'cpu':
                            return (b.cpuCount || 0) - (a.cpuCount || 0);
                        case 'memory':
                            return (b.ramMb || 0) - (a.ramMb || 0);
                        case 'disk':
                            return (b.diskMb || 0) - (a.diskMb || 0);
                        case 'country':
                            return (a.countryCode || '').localeCompare(b.countryCode || '');
                        case 'availability':
                            return (b.hardware_summary?.available_instances || 0) - (a.hardware_summary?.available_instances || 0);
                        default:
                            return (b.quality_score || 0) - (a.quality_score || 0);
                    }
                });
            }

            renderHosts() {
                if (this.filteredHosts.length === 0) {
                    this.elements.hostResults.innerHTML = '<div class="loading">No hosts found</div>';
                    return;
                }
                
                const hostsHtml = this.filteredHosts.map(host => this.renderHostCard(host)).join('');
                this.elements.hostResults.innerHTML = hostsHtml;
            }

            renderHostCard(host) {
                const currentHostDomain = window.location.hostname;
                const isYourHost = (host.domain || '').includes(currentHostDomain);
                const receivesRewards = host.receives_evr_rewards || (host.hostReputation || 0) >= 200;
                
                const cardClasses = ['host-card'];
                if (isYourHost) cardClasses.push('your-host');
                
                const availableInstances = host.hardware_summary?.available_instances || 
                                          Math.max(0, (host.maxInstances || 0) - (host.activeInstances || 0));
                
                return `
                    <div class="${cardClasses.join(' ')}">
                        <div class="host-domain">
                            ${host.domain || 'Unknown Domain'}
                            ${isYourHost ? '<span class="your-host-badge">Your Host</span>' : ''}
                            ${receivesRewards ? '<span class="reward-badge">Rewards</span>' : ''}
                        </div>
                        <div class="host-address">${host.address || ''}</div>
                        
                        <div class="host-info">
                            <div class="info-item">
                                <div class="info-label">Country</div>
                                <div class="info-value">${host.countryCode || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">CPU Cores</div>
                                <div class="info-value">${host.cpuCount || 'N/A'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Memory</div>
                                <div class="info-value">${Math.round((host.ramMb || 0) / 1024)}GB</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Disk</div>
                                <div class="info-value">${Math.round((host.diskMb || 0) / 1024)}GB</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Cost/Hour</div>
                                <div class="info-value">${(host.pricing?.usd_per_hour || host.cost_usd || 0).toFixed(8)}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Available</div>
                                <div class="info-value">${availableInstances} slots</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Reputation</div>
                                <div class="info-value">${host.hostReputation || 0}/252</div>
                            </div>
                        </div>
                        
                        <div class="quality-score">
                            <span>Quality: ${host.quality_score || 0}/100</span>
                            <div class="score-bar">
                                <div class="score-fill" style="width: ${host.quality_score || 0}%"></div>
                            </div>
                        </div>
                        
                        <div class="host-actions">
                            <button class="action-btn primary" onclick="hostDiscovery.showDeployCommand('${host.domain}', '${host.address}')">
                                üìã Copy Deploy
                            </button>
                            <a href="https://${host.domain}" target="_blank" class="action-btn">
                                üåê Visit
                            </a>
                            <button class="action-btn" onclick="hostDiscovery.showHostDetails('${host.address}')">
                                üìä Details
                            </button>
                        </div>
                    </div>
                `;
            }

            showDeployCommand(domain, address) {
                const modal = document.getElementById('deployModal');
                const content = document.getElementById('deployContent');
                
                // Use correct evdevkit syntax based on project knowledge
                const deployCommands = {
                    basic: `evdevkit upload contract.zip http://${domain}/`,
                    acquire: `evdevkit acquire -i your-image:latest--gptcp1--80 http://${domain}/ -m 24`,
                    cluster: `evdevkit cluster-create /path/to/contract cluster_hosts.txt -m 24`
                };
                
                content.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px;">Deploy to: <span style="color: #00ff88;">${domain}</span></h3>
                        <p style="opacity: 0.8; margin-bottom: 20px;">Host Address: <code>${address}</code></p>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="margin-bottom: 10px;">üì§ Upload Contract</h4>
                        <div class="deploy-code">
                            <code>${deployCommands.basic}</code>
                            <button class="action-btn primary" onclick="hostDiscovery.copyCommand('${deployCommands.basic}')" style="margin-left: 15px;">
                                üìã Copy
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="margin-bottom: 10px;">üê≥ Acquire Instance</h4>
                        <div class="deploy-code">
                            <code>${deployCommands.acquire}</code>
                            <button class="action-btn primary" onclick="hostDiscovery.copyCommand('${deployCommands.acquire}')" style="margin-left: 15px;">
                                üìã Copy
                            </button>
                        </div>
                        <p style="font-size: 0.9em; opacity: 0.7; margin-top: 10px;">
                            Replace <code>your-image:latest</code> with your Docker image and adjust port mapping as needed.
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="margin-bottom: 10px;">üèóÔ∏è Cluster Deploy</h4>
                        <div class="deploy-code">
                            <code>${deployCommands.cluster}</code>
                            <button class="action-btn primary" onclick="hostDiscovery.copyCommand('${deployCommands.cluster}')" style="margin-left: 15px;">
                                üìã Copy
                            </button>
                        </div>
                        <p style="font-size: 0.9em; opacity: 0.7; margin-top: 10px;">
                            For multi-host deployments. Create <code>cluster_hosts.txt</code> with selected hosts.
                        </p>
                    </div>
                    
                    <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; padding: 15px; margin-top: 20px;">
                        <strong>üí° Pro Tips:</strong>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>Use <code>-m 24</code> for 24-month lease (longer = cheaper per hour)</li>
                            <li>Add <code>--gptcp1--PORT</code> for port mapping (e.g., <code>--gptcp1--80</code> for web apps)</li>
                            <li>Check host availability before deploying</li>
                        </ul>
                    </div>
                `;
                
                modal.style.display = 'block';
            }

            showHostDetails(address) {
                const host = this.hosts.find(h => h.address === address);
                if (!host) return;
                
                const modal = document.getElementById('hostModal');
                const content = document.getElementById('hostContent');
                
                const receivesRewards = host.receives_evr_rewards || (host.hostReputation || 0) >= 200;
                const memoryGB = Math.round((host.ramMb || 0) / 1024 * 10) / 10;
                const diskGB = Math.round((host.diskMb || 0) / 1024);
                const availableInstances = host.hardware_summary?.available_instances || 
                                          Math.max(0, (host.maxInstances || 0) - (host.activeInstances || 0));
                
                content.innerHTML = `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #00ff88; margin-bottom: 10px;">${host.domain || 'Unknown Domain'}</h3>
                        <p style="font-family: monospace; opacity: 0.8;">${host.address}</p>
                        <p style="opacity: 0.7; margin-top: 5px;">üìç ${host.countryCode || 'Unknown'} | üìß ${host.email || 'Not provided'}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px;">
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px;">
                            <h4 style="color: #00ff88; margin-bottom: 10px;">üèÜ Quality Score</h4>
                            <div style="font-size: 2em; font-weight: bold;">${host.quality_score || 0}/100</div>
                            <div style="margin-top: 10px;">
                                <div style="background: #333; height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: linear-gradient(90deg, #ff6b6b, #ffd700, #00ff88); height: 100%; width: ${host.quality_score || 0}%;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px;">
                            <h4 style="color: #ffd700; margin-bottom: 10px;">‚≠ê Reputation</h4>
                            <div style="font-size: 2em; font-weight: bold;">${host.hostReputation || 0}</div>
                            <div style="opacity: 0.8;">/ 252 max</div>
                            ${receivesRewards ? '<div style="color: #00ff88; font-size: 0.9em; margin-top: 5px;">‚úÖ Receives EVR Rewards</div>' : '<div style="color: #ff6b6b; font-size: 0.9em; margin-top: 5px;">‚ùå Below reward threshold</div>'}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="margin-bottom: 15px;">üñ•Ô∏è Hardware Specifications</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div>
                                <div style="color: #aaa; font-size: 0.9em;">CPU Cores</div>
                                <div style="font-weight: bold;">${host.cpuCount || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="color: #aaa; font-size: 0.9em;">Memory</div>
                                <div style="font-weight: bold;">${memoryGB} GB</div>
                            </div>
                            <div>
                                <div style="color: #aaa; font-size: 0.9em;">Disk Space</div>
                                <div style="font-weight: bold;">${diskGB} GB</div>
                            </div>
                            <div>
                                <div style="color: #aaa; font-size: 0.9em;">CPU Model</div>
                                <div style="font-weight: bold; font-size: 0.8em;">${host.cpuModelName || 'Not specified'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="margin-bottom: 15px;">üìä Instance Availability</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                            <div>
                                <div style="color: #aaa; font-size: 0.9em;">Max Instances</div>
                                <div style="font-weight: bold;">${host.maxInstances || 0}</div>
                            </div>
                            <div>
                                <div style="color: #aaa; font-size: 0.9em;">Active</div>
                                <div style="font-weight: bold; color: #ffd700;">${host.activeInstances || 0}</div>
                            </div>
                            <div>
                                <div style="color: #aaa; font-size: 0.9em;">Available</div>
                                <div style="font-weight: bold; color: #00ff88;">${availableInstances}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h4 style="margin-bottom: 15px;">üí∞ Pricing Information</h4>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                                <div>
                                    <div style="color: #aaa; font-size: 0.9em;">Per Hour</div>
                                    <div style="font-weight: bold;">${(host.pricing?.usd_per_hour || host.cost_usd || 0).toFixed(8)}</div>
                                </div>
                                <div>
                                    <div style="color: #aaa; font-size: 0.9em;">Per Day</div>
                                    <div style="font-weight: bold;">${(host.pricing?.usd_per_day || ((host.pricing?.usd_per_hour || host.cost_usd || 0) * 24)).toFixed(6)}</div>
                                </div>
                                <div>
                                    <div style="color: #aaa; font-size: 0.9em;">Per Month</div>
                                    <div style="font-weight: bold;">${(host.pricing?.usd_per_month || ((host.pricing?.usd_per_hour || host.cost_usd || 0) * 24 * 30)).toFixed(4)}</div>
                                </div>
                                <div>
                                    <div style="color: #aaa; font-size: 0.9em;">EVR Rate</div>
                                    <div style="font-weight: bold;">${host.pricing?.evr_per_hour || host.leaseAmount || 0} EVR/hr</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button class="action-btn primary" onclick="hostDiscovery.showDeployCommand('${host.domain}', '${host.address}')">
                            üöÄ Deploy Here
                        </button>
                        <a href="https://${host.domain}" target="_blank" class="action-btn">
                            üåê Visit Host
                        </a>
                        <button class="action-btn" onclick="hostDiscovery.addToCluster('${host.address}')">
                            ‚ûï Add to Cluster
                        </button>
                    </div>
                `;
                
                modal.style.display = 'block';
            }

            copyCommand(command) {
                navigator.clipboard.writeText(command).then(() => {
                    this.showNotification('üìã Command copied to clipboard!');
                }).catch(() => {
                    this.showNotification('‚ùå Failed to copy command');
                });
            }

            addToCluster(address) {
                // Store in localStorage for cluster management
                let clusterHosts = JSON.parse(localStorage.getItem('clusterHosts') || '[]');
                const host = this.hosts.find(h => h.address === address);
                
                if (host && !clusterHosts.find(h => h.address === address)) {
                    clusterHosts.push({
                        address: host.address,
                        domain: host.domain,
                        quality_score: host.quality_score,
                        country: host.countryCode,
                        cost_usd: host.pricing?.usd_per_hour || host.cost_usd
                    });
                    
                    localStorage.setItem('clusterHosts', JSON.stringify(clusterHosts));
                    this.showNotification(`‚úÖ Added ${host.domain} to cluster list (${clusterHosts.length} hosts)`);
                } else {
                    this.showNotification('‚ö†Ô∏è Host already in cluster or not found');
                }
            }

            updateResultsInfo() {
                this.elements.resultsCount.textContent = this.filteredHosts.length.toLocaleString();
                
                if (this.currentQuery) {
                    this.elements.searchQuery.textContent = ` for "${this.currentQuery}"`;
                } else {
                    this.elements.searchQuery.textContent = '';
                }
            }

            async refreshData() {
                this.elements.refreshBtn.disabled = true;
                this.elements.refreshBtn.textContent = 'üîÑ Refreshing...';
                
                try {
                    await fetch('/api/evernode-stats-cached.php?bust_cache=1');
                    await this.loadData();
                } finally {
                    this.elements.refreshBtn.disabled = false;
                    this.elements.refreshBtn.textContent = 'üîÑ Refresh';
                }
            }

            showNotification(message) {
                // Create notification element
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #00ff88, #00cc99);
                    color: #000;
                    padding: 15px 25px;
                    border-radius: 8px;
                    font-weight: bold;
                    z-index: 10000;
                    transform: translateX(100%);
                    transition: transform 0.3s ease;
                    box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);
                `;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }

            formatNumber(num) {
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'K';
                }
                return num.toLocaleString();
            }
        }

        // Initialize the discovery system
        let hostDiscovery;
        document.addEventListener('DOMContentLoaded', () => {
            hostDiscovery = new HostDiscovery();
        });

        // Export functions for cluster management integration
        window.getSelectedHosts = function() {
            return JSON.parse(localStorage.getItem('clusterHosts') || '[]');
        };

        window.clearClusterHosts = function() {
            localStorage.removeItem('clusterHosts');
            hostDiscovery.showNotification('üóëÔ∏è Cluster list cleared');
        };

        window.exportClusterFile = function() {
            const hosts = JSON.parse(localStorage.getItem('clusterHosts') || '[]');
            if (hosts.length === 0) {
                hostDiscovery.showNotification('‚ö†Ô∏è No hosts in cluster list');
                return;
            }
            
            // Create cluster_hosts.txt content
            const hostList = hosts.map(h => `http://${h.domain}/`).join('\n');
            const blob = new Blob([hostList], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cluster_hosts.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            hostDiscovery.showNotification(`üìÅ Downloaded cluster_hosts.txt with ${hosts.length} hosts`);
        };
    </script>
</body>
</html>
