<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Enhanced Host Discovery - Real Evernode Network</title>
    <link rel="stylesheet" href="/assets/css/unified-navigation.css">
    <script src="/assets/js/unified-state-manager.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            color: #ffffff;
            margin: 0;
            padding: 0;
            margin-top: 70px;
        }

        .discovery-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .discovery-header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .discovery-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .discovery-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .connection-status {
            margin-top: 15px;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            background: rgba(0,255,136,0.2);
            color: #00ff88;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid rgba(0,255,136,0.3);
        }

        .fallback-notice {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.4);
            color: #ffd700;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .fallback-notice a {
            color: #00ff88;
            text-decoration: none;
            font-weight: 600;
        }

        .stats-bar {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stat-item {
            text-align: center;
            color: white;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            display: block;
            color: #667eea;
            transition: all 0.3s ease;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        .controls {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .search-section {
            margin-bottom: 25px;
        }

        .universal-search {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 18px 60px 18px 20px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            font-size: 1.1rem;
            background: rgba(255,255,255,0.1);
            color: #ffffff;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255,255,255,0.15);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }

        .search-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-size: 1.4rem;
        }

        .search-clear {
            position: absolute;
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
            color: #ff6b6b;
            font-size: 1.2rem;
            cursor: pointer;
            display: none;
            transition: all 0.3s ease;
        }

        .search-clear:hover {
            color: #ff5252;
            transform: translateY(-50%) scale(1.1);
        }

        .search-examples {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.6);
            margin-top: 8px;
            line-height: 1.4;
        }

        .search-examples strong {
            color: #667eea;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-group input,
        .control-group select {
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.1);
            color: #ffffff;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255,255,255,0.15);
        }

        .control-group select option {
            background: #1a1a2e;
            color: #ffffff;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin-bottom: 0;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-refresh {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000000;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: auto;
        }

        .btn-refresh:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        .results-header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px 15px 0 0;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.2);
            border-bottom: none;
        }

        .results-info {
            font-weight: 600;
            color: #ffffff;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: rgba(255,255,255,0.1);
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .view-btn.active {
            background: #667eea;
            color: white;
        }

        .view-btn:hover:not(.active) {
            background: rgba(102, 126, 234, 0.2);
        }

        .hosts-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 0 0 15px 15px;
            min-height: 400px;
            border: 1px solid rgba(255,255,255,0.2);
            border-top: none;
        }

        .hosts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            gap: 20px;
            padding: 25px;
        }

        .hosts-list {
            padding: 25px;
        }

        .host-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .host-card:hover {
            transform: translateY(-3px);
            border-color: #667eea;
            background: rgba(255,255,255,0.15);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .host-card.enhanced {
            border-left: 4px solid #00ff88;
            background: rgba(0,255,136,0.1);
        }

        .host-card.featured {
            border: 2px solid #ffd700;
            background: rgba(255,215,0,0.1);
        }

        .host-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .host-domain {
            font-weight: bold;
            font-size: 1.1rem;
            color: #ffffff;
            text-decoration: none;
            word-break: break-word;
            max-width: 250px;
            transition: color 0.3s ease;
        }

        .host-domain:hover {
            color: #667eea;
        }

        .enhanced-badge {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: #000000;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .featured-badge {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000000;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .host-stats {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            align-items: center;
        }

        .stat:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: rgba(255,255,255,0.7);
            font-weight: 500;
            min-width: 120px;
        }

        .stat-value {
            font-weight: 600;
            color: #ffffff;
            text-align: right;
            word-break: break-all;
            max-width: 250px;
        }

        .xrpl-address {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            background: rgba(0, 255, 136, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .xrpl-address:hover {
            background: rgba(0, 255, 136, 0.3);
            transform: scale(1.02);
        }

        .email-address {
            font-size: 0.85rem;
            color: #00ccff;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(0, 204, 255, 0.1);
            border: 1px solid rgba(0, 204, 255, 0.2);
        }

        .email-address:hover {
            color: #ffffff;
            background: rgba(0, 204, 255, 0.2);
            transform: scale(1.02);
        }

        .cpu-model {
            font-size: 0.8rem;
            color: #ffd700;
            font-style: italic;
        }

        .reputation-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .reputation-fill {
            height: 100%;
            background: linear-gradient(to right, #ff6b6b, #ffd93d, #6bcf7f, #4ecdc4, #45b7d1);
            transition: width 0.3s;
        }

        .host-features {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 15px;
        }

        .feature-tag {
            background: rgba(103,126,234,0.2);
            color: #667eea;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            border: 1px solid rgba(103,126,234,0.3);
        }

        .host-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            font-weight: 500;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: #ffffff;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .btn-copy {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .btn-copy:hover {
            background: rgba(0, 255, 136, 0.3);
            transform: translateY(-1px);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 25px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            margin-top: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .page-btn {
            padding: 10px 15px;
            border: 2px solid #667eea;
            background: rgba(255,255,255,0.1);
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            font-weight: 500;
        }

        .page-btn:hover,
        .page-btn.active {
            background: #667eea;
            color: white;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: rgba(255,255,255,0.8);
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(0, 255, 136, 0.9);
            color: #000;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            backdrop-filter: blur(10px);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .error {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .no-results {
            text-align: center;
            padding: 60px;
            color: rgba(255,255,255,0.8);
        }

        .no-results h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .search-suggestions {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .search-suggestions h4 {
            color: #ffd700;
            margin-bottom: 10px;
        }

        .search-suggestions ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .search-suggestions li {
            padding: 5px 0;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .search-suggestions li:hover {
            color: #667eea;
        }

        .host-list-item {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }

        .host-list-item:hover {
            background: rgba(255,255,255,0.15);
            border-color: #667eea;
        }

        @media (max-width: 768px) {
            .discovery-container {
                padding: 10px;
            }

            .discovery-title {
                font-size: 2rem;
            }

            .hosts-grid {
                grid-template-columns: 1fr;
                padding: 15px;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            .host-stats {
                grid-template-columns: 1fr;
            }

            .checkbox-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .pagination {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- Unified Navigation -->
    <nav class="enhanced-nav">
        <div class="nav-container">
            <a href="/" class="nav-brand">üöÄ Enhanced Evernode</a>
            <div class="nav-links">
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/monitoring-dashboard.html" class="nav-link admin-only">Monitoring</a>
                <a href="/my-earnings.html" class="nav-link admin-only">Earnings</a>
                <a href="/host-discovery.html" class="nav-link active">Discovery</a>
                <a href="/cluster/roi-calculator.html" class="btn btn-secondary tenant-only">ROI Calc</a>
                <a href="/cluster/dapp-manager.html" class="nav-link admin-only">Cluster Manager</a>
                <a href="/cluster/paywall.html" style="color: #3b82f6; font-weight: 600;">Premium</a>
            </div>
            <div class="nav-actions">
                <button class="nav-btn" onclick="toggleAdminMode()">üëë</button>
                <div class="role-indicator" id="role-indicator">Tenant Mode</div>
            </div>
        </div>
    </nav>

    <div class="discovery-container">
        <!-- Header -->
        <div class="discovery-header">
            <h1 class="discovery-title">üîç Enhanced Host Discovery</h1>
            <p class="discovery-subtitle">Real-time data from Evernode network ‚Ä¢ Live tracking of 7000+ active hosts ‚Ä¢ Advanced search capabilities</p>
            <div id="connection-status" class="connection-status">
                üì° Connecting to Evernode network...
            </div>
        </div>

        <!-- API Fallback Notice -->
        <div id="fallback-notice" class="fallback-notice">
            ‚ö†Ô∏è Enhanced discovery API temporarily unavailable. 
            <a href="https://xahau.xrplwin.com/evernode" target="_blank">Click here to browse all Evernode hosts</a> 
            or wait for the system to reconnect.
        </div>

        <!-- Network Stats -->
        <div class="stats-bar" id="statsBar">
            <div class="stat-item">
                <span class="stat-value" id="totalHosts">-</span>
                <span class="stat-label">Total Hosts</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="enhancedHosts">-</span>
                <span class="stat-label">Enhanced</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="availableHosts">-</span>
                <span class="stat-label">Available</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="avgReputation">-</span>
                <span class="stat-label">Avg Reputation</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="countries">-</span>
                <span class="stat-label">Countries</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="lastUpdated">-</span>
                <span class="stat-label">Last Updated</span>
            </div>
        </div>

        <!-- Search and Filter Controls -->
        <div class="controls">
            <!-- Universal Search -->
            <div class="search-section">
                <div class="universal-search">
                    <input type="text" id="universalSearch" class="search-input" 
                           placeholder="Search by email, XRPL address, domain, location, hardware...">
                    <span class="search-clear" id="searchClear" onclick="clearSearch()">‚úï</span>
                    <span class="search-icon">üîç</span>
                </div>
                <div class="search-examples">
                    <strong>Examples:</strong> evernodeevr@gmail.com ‚Ä¢ r9Appp6b29X5... ‚Ä¢ Germany ‚Ä¢ AMD EPYC ‚Ä¢ datacenter-nodes.com ‚Ä¢ "reward eligible" ‚Ä¢ "enhanced"
                </div>
            </div>

            <!-- Advanced Filters -->
            <div class="controls-grid">
                <div class="control-group">
                    <label for="country">üåç Country Filter</label>
                    <select id="country">
                        <option value="">All Countries</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="minReputation">‚≠ê Min Reputation: <span id="reputationValue">0</span></label>
                    <input type="range" id="minReputation" min="0" max="255" value="0" 
                           oninput="document.getElementById('reputationValue').textContent = this.value">
                </div>
                <div class="control-group">
                    <label for="sort">üìä Sort By</label>
                    <select id="sort">
                        <option value="reputation_desc">Reputation (High to Low)</option>
                        <option value="reputation_asc">Reputation (Low to High)</option>
                        <option value="domain">Domain Name</option>
                        <option value="enhanced_first">Enhanced First</option>
                        <option value="availability_desc">Most Available</option>
                        <option value="cost_asc">Lowest Cost</option>
                        <option value="rewards_desc">Most Rewards Earned</option>
                        <option value="recent_first">Recently Registered</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="limit">üìÑ Results Per Page</label>
                    <select id="limit">
                        <option value="20" selected>20 hosts</option>
                        <option value="50">50 hosts</option>
                        <option value="100">100 hosts</option>
                        <option value="200">200 hosts</option>
                        <option value="500">500 hosts</option>
                    </select>
                </div>
            </div>
            
            <div class="checkbox-group">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="enhancedOnly">
                    <label for="enhancedOnly">‚ú® Enhanced hosts only</label>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="activeOnly">
                    <label for="activeOnly">üü¢ Available hosts only</label>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="rewardEligible">
                    <label for="rewardEligible">üí∞ Reward eligible only</label>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="hasEmail">
                    <label for="hasEmail">üìß Has email contact</label>
                </div>
                <button class="btn-refresh" onclick="refreshData()">
                    üîÑ Refresh All Data
                </button>
            </div>
        </div>

        <!-- Results Header -->
        <div class="results-header">
            <div class="results-info" id="resultsInfo">
                Loading hosts from Evernode network...
            </div>
            <div class="view-toggle">
                <button class="view-btn active" onclick="setView('grid')" id="gridBtn">üìä Grid</button>
                <button class="view-btn" onclick="setView('list')" id="listBtn">üìã List</button>
            </div>
        </div>

        <!-- Host Results -->
        <div class="hosts-container">
            <div id="hostsContainer" class="loading">
                Downloading all ~7,000 hosts from Evernode network...
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination" style="display: none;">
            <!-- Pagination will be inserted here -->
        </div>
    </div>

    <script>
        class EnhancedEvernodeDiscovery {
            constructor() {
                this.currentPage = 1;
                this.currentView = 'grid';
                this.localAPI = '/api/enhanced-search.php'; // Use local API - no CORS issues
                this.hosts = [];
                this.allHosts = []; // Store all hosts for local searching
                this.totalPages = 1;
                this.lastSearchTime = 0;
                this.countries = new Set();
                
                this.initializeEventListeners();
                this.loadAllHosts();
            }

            initializeEventListeners() {
                // Universal search with debounce
                const searchInput = document.getElementById('universalSearch');
                searchInput.addEventListener('input', (e) => {
                    const clearBtn = document.getElementById('searchClear');
                    if (e.target.value.length > 0) {
                        clearBtn.style.display = 'block';
                    } else {
                        clearBtn.style.display = 'none';
                    }
                    this.debounce(() => this.performSearch(), 300)();
                });
                
                // Filter controls
                document.getElementById('country').addEventListener('change', () => this.performSearch());
                document.getElementById('minReputation').addEventListener('input', () => this.performSearch());
                document.getElementById('sort').addEventListener('change', () => this.performSearch());
                document.getElementById('limit').addEventListener('change', () => this.performSearch());
                document.getElementById('enhancedOnly').addEventListener('change', () => this.performSearch());
                document.getElementById('activeOnly').addEventListener('change', () => this.performSearch());
                document.getElementById('rewardEligible').addEventListener('change', () => this.performSearch());
                document.getElementById('hasEmail').addEventListener('change', () => this.performSearch());
            }

            async loadAllHosts() {
                this.showLoading();
                this.updateConnectionStatus('üì° Downloading all hosts from Evernode network...');

                try {
                    console.log('üîç Fetching all hosts from local API...');
                    
                    // First get stats
                    const statsResponse = await fetch(`${this.localAPI}?action=stats`);
                    if (statsResponse.ok) {
                        const statsData = await statsResponse.json();
                        if (statsData.success) {
                            this.updateNetworkStats(statsData);
                        }
                    }

                    // Then get all hosts (increased limit to get all hosts)
                    const hostsResponse = await fetch(`${this.localAPI}?action=search&limit=10000`);
                    
                    if (!hostsResponse.ok) {
                        throw new Error(`API responded with status: ${hostsResponse.status}`);
                    }

                    const data = await hostsResponse.json();
                    
                    if (!data.success) {
                        throw new Error(data.error || 'API returned error');
                    }

                    console.log('‚úÖ Loaded', data.hosts?.length || 0, 'hosts from local API');

                    this.allHosts = data.hosts || [];
                    this.populateCountryFilter();
                    this.updateConnectionStatus(`‚úÖ Connected - ${this.allHosts.length} hosts cached locally`);
                    this.hideFallbackNotice();
                    
                    // Update last updated time
                    document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
                    
                    // Initial search/display
                    this.performSearch();

                } catch (error) {
                    console.error('‚ùå Local API error:', error);
                    this.showError('Failed to connect to enhanced-search API: ' + error.message);
                    this.updateConnectionStatus('‚ùå Local API unavailable');
                    this.showFallbackNotice();
                }
            }

            populateCountryFilter() {
                // Extract unique countries from all hosts
                this.countries.clear();
                this.allHosts.forEach(host => {
                    if (host.country && host.country !== 'Unknown') {
                        this.countries.add(host.country);
                    }
                });

                // Sort countries alphabetically
                const sortedCountries = Array.from(this.countries).sort();
                
                // Populate dropdown
                const countrySelect = document.getElementById('country');
                const currentValue = countrySelect.value;
                
                // Clear existing options except "All Countries"
                countrySelect.innerHTML = '<option value="">All Countries</option>';
                
                // Add sorted countries
                sortedCountries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country;
                    option.textContent = country;
                    countrySelect.appendChild(option);
                });

                // Restore selection if it exists
                if (currentValue && sortedCountries.includes(currentValue)) {
                    countrySelect.value = currentValue;
                }
            }

            performSearch() {
                this.currentPage = 1; // Reset to first page on new search
                
                const searchTerm = document.getElementById('universalSearch').value.toLowerCase().trim();
                const country = document.getElementById('country').value;
                const minReputation = parseInt(document.getElementById('minReputation').value);
                const enhancedOnly = document.getElementById('enhancedOnly').checked;
                const activeOnly = document.getElementById('activeOnly').checked;
                const rewardEligible = document.getElementById('rewardEligible').checked;
                const hasEmail = document.getElementById('hasEmail').checked;
                const sortBy = document.getElementById('sort').value;

                let filteredHosts = [...this.allHosts];

                // Universal search across all fields
                if (searchTerm) {
                    filteredHosts = filteredHosts.filter(host => {
                        const searchableText = [
                            host.domain || '',
                            host.email || host.operator_email || '',
                            host.address || host.xahau_address || '',
                            host.country || '',
                            host.cpu_model || '',
                            host.domain_tld || '',
                            host.description || '',
                            host.enhanced ? 'enhanced' : '',
                            host.evr_rewards_eligible ? 'reward eligible' : '',
                            (host.available_instances || 0) > 0 ? 'available' : 'busy'
                        ].join(' ').toLowerCase();
                        
                        return searchableText.includes(searchTerm);
                    });
                }

                // Apply other filters
                if (country) {
                    filteredHosts = filteredHosts.filter(host => host.country === country);
                }

                if (minReputation > 0) {
                    filteredHosts = filteredHosts.filter(host => (host.reputation || 0) >= minReputation);
                }

                if (enhancedOnly) {
                    filteredHosts = filteredHosts.filter(host => host.enhanced);
                }

                if (activeOnly) {
                    filteredHosts = filteredHosts.filter(host => (host.available_instances || 0) > 0);
                }

                if (rewardEligible) {
                    filteredHosts = filteredHosts.filter(host => host.evr_rewards_eligible);
                }

                if (hasEmail) {
                    filteredHosts = filteredHosts.filter(host => host.email || host.operator_email);
                }

                // Sort results
                this.sortHosts(filteredHosts, sortBy);

                // Store filtered results
                this.hosts = filteredHosts;

                // Apply pagination and display
                this.displayPaginatedResults();
            }

            sortHosts(hosts, sortBy) {
                switch (sortBy) {
                    case 'reputation_desc':
                        hosts.sort((a, b) => (b.reputation || 0) - (a.reputation || 0));
                        break;
                    case 'reputation_asc':
                        hosts.sort((a, b) => (a.reputation || 0) - (b.reputation || 0));
                        break;
                    case 'domain':
                        hosts.sort((a, b) => (a.domain || '').localeCompare(b.domain || ''));
                        break;
                    case 'enhanced_first':
                        hosts.sort((a, b) => {
                            if (a.enhanced && !b.enhanced) return -1;
                            if (!a.enhanced && b.enhanced) return 1;
                            return (b.reputation || 0) - (a.reputation || 0);
                        });
                        break;
                    case 'availability_desc':
                        hosts.sort((a, b) => (b.available_instances || 0) - (a.available_instances || 0));
                        break;
                    case 'cost_asc':
                        hosts.sort((a, b) => (a.cost_per_hour_usd || 999) - (b.cost_per_hour_usd || 999));
                        break;
                    case 'rewards_desc':
                        hosts.sort((a, b) => (parseFloat(b.accumulated_rewards || 0)) - (parseFloat(a.accumulated_rewards || 0)));
                        break;
                    case 'recent_first':
                        hosts.sort((a, b) => {
                            const dateA = new Date(a.registration_timestamp || 0);
                            const dateB = new Date(b.registration_timestamp || 0);
                            return dateB - dateA;
                        });
                        break;
                }
            }

            displayPaginatedResults() {
                const limit = parseInt(document.getElementById('limit').value);
                const startIndex = (this.currentPage - 1) * limit;
                const endIndex = startIndex + limit;
                const paginatedHosts = this.hosts.slice(startIndex, endIndex);

                this.totalPages = Math.ceil(this.hosts.length / limit);

                // Update displays
                this.updateResultsInfo(this.hosts.length, startIndex + 1, Math.min(endIndex, this.hosts.length));
                this.renderHosts(paginatedHosts);
                this.renderPagination();
            }

            updateNetworkStats(statsData) {
                document.getElementById('totalHosts').textContent = (statsData.total_hosts || 0).toLocaleString();
                document.getElementById('enhancedHosts').textContent = (statsData.enhanced_hosts || 0).toLocaleString();
                document.getElementById('availableHosts').textContent = (statsData.available_hosts || 0).toLocaleString();
                
                // Calculate additional stats from all hosts
                if (this.allHosts.length > 0) {
                    const avgReputation = Math.round(
                        this.allHosts.reduce((sum, h) => sum + (h.reputation || 0), 0) / this.allHosts.length
                    );
                    const countries = new Set(this.allHosts.map(h => h.country || 'Unknown')).size;
                    
                    document.getElementById('avgReputation').textContent = avgReputation;
                    document.getElementById('countries').textContent = countries;
                }
            }

            updateResultsInfo(total, start, end) {
                const info = total === 0 ? 'No hosts found' : `Showing ${start}-${end} of ${total.toLocaleString()} hosts`;
                document.getElementById('resultsInfo').textContent = info;
            }

            renderHosts(hosts) {
                const container = document.getElementById('hostsContainer');
                
                if (hosts.length === 0) {
                    this.renderNoResults(container);
                    return;
                }

                if (this.currentView === 'grid') {
                    this.renderHostsGrid(container, hosts);
                } else {
                    this.renderHostsList(container, hosts);
                }
            }

            renderNoResults(container) {
                const searchTerm = document.getElementById('universalSearch').value;
                const hasFilters = document.getElementById('country').value || 
                                 document.getElementById('minReputation').value > 0 ||
                                 document.getElementById('enhancedOnly').checked ||
                                 document.getElementById('activeOnly').checked ||
                                 document.getElementById('rewardEligible').checked ||
                                 document.getElementById('hasEmail').checked;

                container.innerHTML = `
                    <div class="no-results">
                        <h3>No hosts found</h3>
                        ${searchTerm ? `<p>No results for: <strong>"${searchTerm}"</strong></p>` : ''}
                        ${hasFilters ? '<p>Try adjusting your search criteria or filters</p>' : ''}
                        
                        <div class="search-suggestions">
                            <h4>üí° Search Tips:</h4>
                            <ul>
                                <li onclick="setSampleSearch('evernodeevr@gmail.com')">‚Ä¢ Try searching for email: evernodeevr@gmail.com</li>
                                <li onclick="setSampleSearch('r9Appp6b29X5')">‚Ä¢ Search by XRPL address: r9Appp6b29X5...</li>
                                <li onclick="setSampleSearch('Germany')">‚Ä¢ Search by country: Germany</li>
                                <li onclick="setSampleSearch('AMD EPYC')">‚Ä¢ Search by hardware: AMD EPYC</li>
                                <li onclick="setSampleSearch('enhanced')">‚Ä¢ Search for enhanced hosts</li>
                            </ul>
                        </div>
                    </div>
                `;
            }

            renderHostsGrid(container, hosts) {
                container.className = 'hosts-grid';
                container.innerHTML = hosts.map(host => {
                    const domain = host.domain || host.address || 'Unknown';
                    const reputation = host.reputation || 0;
                    const country = host.country || 'Unknown';
                    const uri = host.uri || (domain.includes('.') ? `https://${domain}` : null);
                    const enhanced = host.enhanced || false;
                    const email = host.email || host.operator_email || null;
                    const xrplAddress = host.address || host.xahau_address || '';
                    const cpuModel = host.cpu_model || 'Not specified';
                    const accumulatedRewards = host.accumulated_rewards || '0';
                    
                    return `
                        <div class="host-card ${enhanced ? 'enhanced' : ''} ${reputation >= 240 ? 'featured' : ''}">
                            <div class="host-header">
                                <a href="${uri || '#'}" class="host-domain" target="_blank">
                                    ${domain}
                                </a>
                                <div>
                                    ${enhanced ? '<span class="enhanced-badge">Enhanced</span>' : ''}
                                    ${reputation >= 240 ? '<span class="featured-badge">Top Host</span>' : ''}
                                </div>
                            </div>
                            
                            <div class="host-stats">
                                <div class="stat">
                                    <span class="stat-label">üîó XRPL Address:</span>
                                    <span class="stat-value">
                                        <span class="xrpl-address" onclick="discovery.copyToClipboard('${xrplAddress}', 'XRPL address')">
                                            ${xrplAddress.substring(0, 20)}...
                                        </span>
                                    </span>
                                </div>
                                
                                ${email ? `
                                <div class="stat">
                                    <span class="stat-label">üìß Operator Email:</span>
                                    <span class="stat-value">
                                        <span class="email-address" onclick="discovery.copyToClipboard('${email}', 'Email address')">
                                            ${email}
                                        </span>
                                    </span>
                                </div>
                                ` : ''}
                                
                                <div class="stat">
                                    <span class="stat-label">üåç Country:</span>
                                    <span class="stat-value">${country}</span>
                                </div>
                                
                                <div class="stat">
                                    <span class="stat-label">‚≠ê Reputation:</span>
                                    <span class="stat-value" style="color: ${reputation >= 240 ? '#ffd700' : reputation >= 200 ? '#00ff88' : reputation >= 100 ? '#ffd93d' : '#fca5a5'}">${reputation}</span>
                                </div>
                                
                                <div class="stat">
                                    <span class="stat-label">üñ•Ô∏è CPU Model:</span>
                                    <span class="stat-value cpu-model">${cpuModel}</span>
                                </div>
                                
                                <div class="stat">
                                    <span class="stat-label">‚ö° Resources:</span>
                                    <span class="stat-value">${host.cpu_cores || 4}c/${host.memory_gb || 8}GB/${host.disk_gb || 50}GB</span>
                                </div>
                                
                                <div class="stat">
                                    <span class="stat-label">üìä Instances:</span>
                                    <span class="stat-value">${host.available_instances || 0}/${host.max_instances || 3} available</span>
                                </div>
                                
                                <div class="stat">
                                    <span class="stat-label">üí≤ Cost/hour:</span>
                                    <span class="stat-value">$${(host.cost_per_hour_usd || 0).toFixed(6)} USD</span>
                                </div>
                                
                                <div class="stat">
                                    <span class="stat-label">üí∞ Rewards Earned:</span>
                                    <span class="stat-value" style="color: #ffd700">${parseFloat(accumulatedRewards).toFixed(3)} EVR</span>
                                </div>
                                
                                <div class="stat">
                                    <span class="stat-label">üîÑ Status:</span>
                                    <span class="stat-value" style="color: ${(host.available_instances || 0) > 0 ? '#00ff88' : '#fbbf24'}">
                                        ${(host.available_instances || 0) > 0 ? 'üü¢ Available' : 'üü° Busy'}
                                    </span>
                                </div>
                                
                                ${host.evr_rewards_eligible ? `
                                <div class="stat">
                                    <span class="stat-label">üéØ EVR Rewards:</span>
                                    <span class="stat-value" style="color: #00ff88">‚úÖ Eligible</span>
                                </div>
                                ` : ''}
                            </div>

                            <div class="reputation-bar">
                                <div class="reputation-fill" style="width: ${(reputation / 255) * 100}%"></div>
                            </div>

                            ${host.features && host.features.length ? `
                            <div class="host-features">
                                ${host.features.map(feature => `<span class="feature-tag">${feature}</span>`).join('')}
                            </div>
                            ` : ''}

                            <div class="host-actions">
                                ${uri ? `<a href="${uri}" class="btn btn-primary" target="_blank">üåê Visit Host</a>` : ''}
                                <button class="btn btn-copy" onclick="discovery.copyToClipboard('${xrplAddress}', 'XRPL address')">
                                    üìã Copy XRPL
                                </button>
                                ${email ? `<button class="btn btn-copy" onclick="discovery.copyToClipboard('${email}', 'Email address')">
                                    üìß Copy Email
                                </button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderHostsList(container, hosts) {
                container.className = 'hosts-list';
                container.innerHTML = hosts.map(host => {
                    const domain = host.domain || host.address || 'Unknown';
                    const reputation = host.reputation || 0;
                    const country = host.country || 'Unknown';
                    const enhanced = host.enhanced || false;
                    const email = host.email || host.operator_email || null;
                    const xrplAddress = host.address || host.xahau_address || '';
                    
                    return `
                        <div class="host-list-item">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div>
                                    <strong style="color: #667eea; font-size: 1.1rem;">${domain}</strong>
                                    ${enhanced ? '<span class="enhanced-badge" style="margin-left: 10px;">Enhanced</span>' : ''}
                                </div>
                                <div style="color: #ffd700;">‚≠ê ${reputation}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 0.9rem;">
                                <div><strong>üåç Country:</strong> ${country}</div>
                                <div><strong>üìä Instances:</strong> ${host.available_instances || 0}/${host.max_instances || 3}</div>
                                <div><strong>üí≤ Cost:</strong> $${(host.cost_per_hour_usd || 0).toFixed(6)}/hour</div>
                                ${email ? `<div><strong>üìß Email:</strong> <span class="email-address" onclick="discovery.copyToClipboard('${email}', 'Email')">${email}</span></div>` : ''}
                            </div>
                            <div style="margin-top: 10px;">
                                <span style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">XRPL:</span>
                                <span class="xrpl-address" onclick="discovery.copyToClipboard('${xrplAddress}', 'XRPL address')" style="margin-left: 5px;">
                                    ${xrplAddress}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderPagination() {
                const container = document.getElementById('pagination');
                
                if (this.totalPages <= 1) {
                    container.style.display = 'none';
                    return;
                }

                container.style.display = 'flex';
                
                let html = '';
                
                // Previous button
                html += `<button class="page-btn" ${this.currentPage <= 1 ? 'disabled' : ''} 
                         onclick="discovery.goToPage(${this.currentPage - 1})">‚Äπ Previous</button>`;
                
                // Page numbers
                const startPage = Math.max(1, this.currentPage - 2);
                const endPage = Math.min(this.totalPages, this.currentPage + 2);
                
                if (startPage > 1) {
                    html += `<button class="page-btn" onclick="discovery.goToPage(1)">1</button>`;
                    if (startPage > 2) html += `<span style="padding: 10px; color: rgba(255,255,255,0.5);">...</span>`;
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    html += `<button class="page-btn ${i === this.currentPage ? 'active' : ''}" 
                             onclick="discovery.goToPage(${i})">${i}</button>`;
                }
                
                if (endPage < this.totalPages) {
                    if (endPage < this.totalPages - 1) html += `<span style="padding: 10px; color: rgba(255,255,255,0.5);">...</span>`;
                    html += `<button class="page-btn" onclick="discovery.goToPage(${this.totalPages})">${this.totalPages}</button>`;
                }
                
                // Next button
                html += `<button class="page-btn" ${this.currentPage >= this.totalPages ? 'disabled' : ''} 
                         onclick="discovery.goToPage(${this.currentPage + 1})">Next ‚Ä∫</button>`;
                
                container.innerHTML = html;
            }

            goToPage(page) {
                if (page < 1 || page > this.totalPages) return;
                this.currentPage = page;
                this.displayPaginatedResults();
                
                // Scroll to top of results
                document.getElementById('hostsContainer').scrollIntoView({ behavior: 'smooth' });
            }

            setView(view) {
                this.currentView = view;
                document.getElementById('gridBtn').classList.toggle('active', view === 'grid');
                document.getElementById('listBtn').classList.toggle('active', view === 'list');
                this.displayPaginatedResults();
            }

            async refreshData() {
                this.currentPage = 1;
                document.getElementById('lastUpdated').textContent = 'Refreshing...';
                await this.loadAllHosts();
            }

            copyToClipboard(text, type) {
                navigator.clipboard.writeText(text).then(() => {
                    this.showSuccess(`${type} copied to clipboard!`);
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    this.showSuccess(`${type} copied to clipboard!`);
                });
            }

            updateConnectionStatus(message) {
                const status = document.getElementById('connection-status');
                if (status) {
                    status.textContent = message;
                    
                    if (message.includes('Connected') || message.includes('cached')) {
                        status.style.background = 'rgba(0,255,136,0.2)';
                        status.style.color = '#00ff88';
                    } else if (message.includes('unavailable') || message.includes('failed')) {
                        status.style.background = 'rgba(239,68,68,0.2)';
                        status.style.color = '#fca5a5';
                    } else {
                        status.style.background = 'rgba(255,193,7,0.2)';
                        status.style.color = '#ffd700';
                    }
                }
            }

            showFallbackNotice() {
                document.getElementById('fallback-notice').style.display = 'block';
            }

            hideFallbackNotice() {
                document.getElementById('fallback-notice').style.display = 'none';
            }

            showLoading() {
                document.getElementById('hostsContainer').innerHTML = 
                    '<div class="loading">Downloading all ~7,000 hosts from Evernode network...</div>';
            }

            showError(message) {
                document.getElementById('hostsContainer').innerHTML = 
                    `<div class="error">‚ùå Error: ${message}<br><br>Please check that your enhanced-search.php API is working correctly.</div>`;
            }

            showSuccess(message) {
                const alert = document.createElement('div');
                alert.className = 'success-message';
                alert.textContent = message;
                document.body.appendChild(alert);
                
                setTimeout(() => alert.remove(), 3000);
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        }

        // Global functions for onclick handlers
        window.setView = (view) => discovery.setView(view);
        window.refreshData = () => discovery.refreshData();
        window.clearSearch = () => {
            document.getElementById('universalSearch').value = '';
            document.getElementById('searchClear').style.display = 'none';
            discovery.performSearch();
        };
        window.setSampleSearch = (term) => {
            document.getElementById('universalSearch').value = term;
            document.getElementById('searchClear').style.display = 'block';
            discovery.performSearch();
        };

        // Initialize the discovery system
        document.addEventListener('DOMContentLoaded', function() {
            window.discovery = new EnhancedEvernodeDiscovery();
        });
    </script>
</body>
</html>
